<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDF æ™ºèƒ½æµæ°´åˆ†æ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- å¼•å…¥ SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .loader {
            border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-center p-4 sm:p-6">

    <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-lg w-full max-w-4xl border border-gray-100 mx-auto">
        <!-- æ ‡é¢˜åŒº -->
        <div class="text-center mb-6 sm:mb-10">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-2">ğŸ’° PDF æµæ°´æ™ºèƒ½åˆ†æ</h1>
            <p class="text-sm text-slate-500 px-4">æ‰‹æœºç«¯ä¸“ç”¨ Â· è‡ªåŠ¨å‰”é™¤æ— æ•ˆæµæ°´ Â· è®¡ç®—çœŸå®æ”¶å…¥</p>
        </div>

        <!-- ä¸Šä¼ åŒº (é€‚é…æ‰‹æœºè§¦æ‘¸) -->
        <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 sm:p-12 text-center active:bg-blue-50 transition-all duration-200 group relative overflow-hidden touch-manipulation">
            <input type="file" id="file-input" class="hidden" accept=".pdf">
            <div class="relative z-10 flex flex-col items-center justify-center space-y-3">
                <div class="p-4 bg-blue-50 rounded-full text-blue-600 mb-2">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <div>
                    <div class="text-lg font-bold text-slate-700">ç‚¹å‡»é€‰æ‹© PDF æ–‡ä»¶</div>
                    <p class="text-xs text-slate-400 mt-2">æ”¯æŒå¾®ä¿¡/æ”¯ä»˜å®è´¦å•</p>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ä¸è¿›åº¦ -->
        <div id="status-area" class="mt-6 hidden fade-in">
            <div class="flex items-center justify-between mb-2">
                <span id="status-text" class="text-slate-700 font-medium text-xs">å‡†å¤‡å°±ç»ª</span>
                <span id="percent-text" class="text-blue-600 font-bold text-xs">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="analysis-msg" class="text-xs text-slate-400 mt-2 text-center h-4 truncate"></p>
        </div>

        <!-- ç»“æœä¸ä¸‹è½½ -->
        <div id="result-area" class="mt-8 hidden fade-in">
            <!-- æ”¶å…¥æ¦‚è§ˆå¡ç‰‡ (æ‰‹æœºç«¯è‡ªåŠ¨ç«–æ’) -->
            <div class="grid grid-cols-1 gap-3 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 flex justify-between items-center">
                    <div>
                        <div class="text-blue-500 text-xs font-bold uppercase">åŸå§‹æ€»å…¥è´¦</div>
                        <div class="text-lg font-bold text-slate-800 mt-1" id="total-raw-income">Â¥ 0.00</div>
                    </div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 border border-green-100 relative overflow-hidden">
                    <div class="text-green-600 text-xs font-bold uppercase mb-1">æ¸…æ´—åÂ·å®é™…æœ‰æ•ˆæ”¶å…¥</div>
                    <div class="text-2xl font-bold text-green-700" id="total-real-income">Â¥ 0.00</div>
                    <p class="text-xs text-green-600/70 mt-1">å·²å‰”é™¤æ— æ•ˆåŠè¿‡æ¡¥èµ„é‡‘</p>
                </div>
            </div>

            <div class="text-center">
                <button id="download-btn" class="w-full sm:w-auto bg-slate-900 hover:bg-black text-white font-bold py-3.5 px-8 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center mx-auto text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¿å­˜ Excel æŠ¥è¡¨
                </button>
                <p class="text-xs text-slate-400 mt-3 px-2">æç¤ºï¼šiPhone ç”¨æˆ·ä¸‹è½½åè¯·åœ¨â€œæ–‡ä»¶â€Appä¸­æŸ¥çœ‹</p>
            </div>
        </div>

    </div>

    <div class="mt-6 text-center text-slate-400 text-[10px]">
        <p>ğŸ”’ æœ¬åœ°å®‰å…¨è®¡ç®—ï¼Œæ— æ•°æ®ä¸Šä¼ </p>
    </div>

<script>
    // è·å– DOM å…ƒç´ 
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const statusArea = document.getElementById('status-area');
    const resultArea = document.getElementById('result-area');
    const statusText = document.getElementById('status-text');
    const percentText = document.getElementById('percent-text');
    const progressBar = document.getElementById('progress-bar');
    const downloadBtn = document.getElementById('download-btn');
    const analysisMsg = document.getElementById('analysis-msg');

    let finalGridData = [];
    let currentFileName = '';
    let allRawItems = [];

    // --- UI äº¤äº’ (é€‚é…è§¦æ‘¸) ---
    dropZone.addEventListener('click', () => fileInput.click());
    
    // æ‰‹æœºç«¯ä¸éœ€è¦ dragover/dropï¼Œä¸»è¦ä¾èµ– click
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    // --- ä¸»å¤„ç†æµç¨‹ ---
    async function handleFile(file) {
        if (file.type !== 'application/pdf') {
            alert('è¯·ä¸Šä¼  PDF æ–‡ä»¶ï¼');
            return;
        }

        currentFileName = file.name.replace('.pdf', '');
        
        // UI é‡ç½®
        statusArea.classList.remove('hidden');
        resultArea.classList.add('hidden');
        dropZone.classList.add('opacity-50', 'pointer-events-none');
        progressBar.style.width = '0%';
        allRawItems = [];
        analysisMsg.innerText = "å‡†å¤‡è§£æ...";

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const totalPages = pdf.numPages;
            
            // 1. æå–å†…å®¹
            for (let i = 1; i <= totalPages; i++) {
                statusText.innerText = `è¯»å–ä¸­ ${i}/${totalPages}`;
                let pct = Math.round((i / totalPages) * 60); 
                progressBar.style.width = `${pct}%`;
                percentText.innerText = `${pct}%`;
                
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                textContent.items.forEach(item => {
                    const text = item.str.trim();
                    if (text) {
                        allRawItems.push({
                            x: Math.round(item.transform[4]),
                            y: Math.round(item.transform[5]),
                            text: text,
                            page: i
                        });
                    }
                });
            }

            // 2. ç»“æ„åŒ–
            statusText.innerText = "æ­£åœ¨æ•´ç†è¡¨æ ¼...";
            progressBar.style.width = '75%';
            percentText.innerText = '75%';
            
            // å»¶æ—¶è®©UIæ¸²æŸ“
            setTimeout(() => {
                let grid = processSmartGrid(allRawItems);
                
                // 3. é‡‘èåˆ†æ
                statusText.innerText = "æ­£åœ¨æ¸…æ´—æ•°æ®...";
                analysisMsg.innerText = "å‰”é™¤æ— æ•ˆèµ„é‡‘ä¸è¿‡æ¡¥æµæ°´...";
                progressBar.style.width = '90%';
                percentText.innerText = '90%';

                setTimeout(() => {
                    finalGridData = analyzeFinancials(grid);
                    
                    progressBar.style.width = '100%';
                    percentText.innerText = '100%';
                    statusArea.classList.add('hidden');
                    resultArea.classList.remove('hidden');
                    dropZone.classList.remove('opacity-50', 'pointer-events-none');
                }, 300);
            }, 50);

        } catch (error) {
            console.error(error);
            alert('è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿ PDF æœªåŠ å¯†');
            statusArea.classList.add('hidden');
            dropZone.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    // --- æ ¸å¿ƒç®—æ³•1ï¼šæ™ºèƒ½è¡¨æ ¼å¯¹é½ ---
    function processSmartGrid(items) {
        if (items.length === 0) return [];
        const Y_TOLERANCE = 4;
        const X_TOLERANCE = 15; 

        let allRows = [];
        const maxPage = items[items.length - 1].page;
        for (let p = 1; p <= maxPage; p++) {
            let pageItems = items.filter(i => i.page === p);
            pageItems.sort((a, b) => b.y - a.y);
            let currentRows = [];
            pageItems.forEach(item => {
                let foundRow = currentRows.find(r => Math.abs(r.y - item.y) < Y_TOLERANCE);
                if (foundRow) foundRow.items.push(item);
                else currentRows.push({ y: item.y, items: [item] });
            });
            allRows.push(...currentRows);
        }

        let allX = items.map(i => i.x);
        let columnCenters = [];
        allX.sort((a, b) => a - b);
        allX.forEach(x => {
            let foundCol = columnCenters.find(c => Math.abs(c - x) < X_TOLERANCE);
            if (!foundCol) columnCenters.push(x);
        });
        columnCenters.sort((a, b) => a - b);

        let grid = [];
        allRows.forEach(row => {
            let rowData = new Array(columnCenters.length).fill("");
            row.items.forEach(item => {
                let bestColIndex = -1;
                let minDiff = Infinity;
                columnCenters.forEach((colX, index) => {
                    let diff = Math.abs(colX - item.x);
                    if (diff < minDiff) { minDiff = diff; bestColIndex = index; }
                });
                if (bestColIndex !== -1) {
                    if (rowData[bestColIndex]) rowData[bestColIndex] += " " + item.text;
                    else rowData[bestColIndex] = item.text;
                }
            });
            if (rowData.some(cell => cell.trim() !== "")) grid.push(rowData);
        });
        return grid;
    }

    // --- æ ¸å¿ƒç®—æ³•2ï¼šé‡‘èé€»è¾‘ (å«å¿«è¿›å¿«å‡ºå‰”é™¤) ---
    function analyzeFinancials(grid) {
        if (!grid || grid.length < 2) return grid;

        let headerRowIdx = -1;
        let colMap = { date: -1, amount: -1, desc: -1 };

        // æ‰¾è¡¨å¤´
        for (let r = 0; r < Math.min(grid.length, 15); r++) {
            const rowStr = grid[r].join(" ").toLowerCase();
            if ((rowStr.includes("é‡‘é¢") || rowStr.includes("amount")) && (rowStr.includes("æ—¶é—´") || rowStr.includes("æ—¥æœŸ"))) {
                headerRowIdx = r;
                grid[r].forEach((cell, cIdx) => {
                    const txt = cell.trim();
                    if (txt.includes("æ—¶é—´") || txt.includes("æ—¥æœŸ") || txt.match(/\d{4}-\d{2}/)) colMap.date = cIdx;
                    else if (txt.includes("é‡‘é¢") || txt.includes("amount")) colMap.amount = cIdx;
                    else if (txt.includes("æ‘˜è¦") || txt.includes("è¯´æ˜") || txt.includes("å¯¹æ–¹") || txt.includes("å•†å“") || txt.includes("å¤‡æ³¨")) {
                        if (colMap.desc === -1) colMap.desc = cIdx;
                    }
                });
                break;
            }
        }

        if (headerRowIdx === -1 || colMap.amount === -1) return grid;

        grid[headerRowIdx].push("å®é™…æœ‰æ•ˆæ”¶å…¥");
        grid[headerRowIdx].push("å¤‡æ³¨è¯´æ˜");

        let transactions = [];
        let totalRawIncome = 0;
        
        for (let r = headerRowIdx + 1; r < grid.length; r++) {
            const row = grid[r];
            const dateStr = colMap.date > -1 ? row[colMap.date] : "";
            const amountStr = row[colMap.amount];
            const descStr = colMap.desc > -1 ? grid[r].map((c, i) => (i !== colMap.date && i !== colMap.amount) ? c : "").join(" ") : "";

            const dateMatch = dateStr.match(/\d{4}[-./]\d{1,2}[-./]\d{1,2}/);
            const dateKey = dateMatch ? dateMatch[0].replace(/[./]/g, '-') : "unknown";

            let amountVal = 0;
            let type = "unknown";
            if (amountStr) {
                const cleanAmt = amountStr.replace(/[Â¥,]/g, "").trim();
                amountVal = parseFloat(cleanAmt);
                if (amountStr.includes("-") || cleanAmt.startsWith("-")) {
                    type = "expense";
                    amountVal = Math.abs(amountVal);
                } else if (amountStr.includes("+") || !isNaN(amountVal)) {
                    type = "income";
                    totalRawIncome += amountVal;
                }
            }

            transactions.push({
                rIdx: r,
                date: dateKey,
                amount: amountVal,
                type: type,
                desc: descStr,
                isExcluded: false,
                reason: ""
            });
        }

        // æ¸…æ´—: å…³é”®è¯
        const excludeKeywords = ["æœ¬äºº", "è‡ªå·±", "æç°", "å……å€¼", "ç†è´¢", "èµå›", "å€Ÿå‘—", "å¾®ç²’è´·", "è¿˜æ¬¾", "é€€æ¬¾", "ä¿¡ç”¨å¡"];
        transactions.forEach(tx => {
            if (tx.type === "income") {
                for (let kw of excludeKeywords) {
                    if (tx.desc.includes(kw)) {
                        tx.isExcluded = true;
                        tx.reason = `å‰”é™¤: ${kw}`;
                        break;
                    }
                }
            }
        });

        // æ¸…æ´—: å½“æ—¥å¿«è¿›å¿«å‡º
        const txByDate = {};
        transactions.forEach(tx => {
            if (tx.date === "unknown") return;
            if (!txByDate[tx.date]) txByDate[tx.date] = [];
            txByDate[tx.date].push(tx);
        });

        Object.keys(txByDate).forEach(date => {
            const dayTxs = txByDate[date];
            const incomes = dayTxs.filter(t => t.type === "income" && !t.isExcluded);
            const expenses = dayTxs.filter(t => t.type === "expense");

            incomes.forEach(inc => {
                const matchExp = expenses.find(exp => {
                    const diff = Math.abs(exp.amount - inc.amount);
                    return diff < 5 || (diff / inc.amount < 0.01);
                });
                if (matchExp) {
                    inc.isExcluded = true;
                    inc.reason = `å‰”é™¤: å¿«è¿›å¿«å‡º (Â¥${matchExp.amount})`;
                }
            });
        });

        // æ±‡æ€»ä¸å›å¡«
        let totalRealIncome = 0;
        transactions.forEach(tx => {
            const row = grid[tx.rIdx];
            if (tx.type === "income") {
                if (tx.isExcluded) {
                    row.push("0");
                    row.push(tx.reason);
                } else {
                    row.push(tx.amount.toFixed(2));
                    row.push("æœ‰æ•ˆ");
                    totalRealIncome += tx.amount;
                }
            } else {
                row.push("");
                row.push("");
            }
        });

        // è¡¥é½ Footer
        for (let r = headerRowIdx + 1; r < grid.length; r++) {
            while (grid[r].length < grid[headerRowIdx].length) grid[r].push("");
        }

        document.getElementById('total-raw-income').innerText = `Â¥ ${totalRawIncome.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
        document.getElementById('total-real-income').innerText = `Â¥ ${totalRealIncome.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;

        return grid;
    }

    // --- ä¸‹è½½ Excel ---
    downloadBtn.addEventListener('click', () => {
        if (!finalGridData.length) return;
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(finalGridData);
        const wscols = finalGridData[0].map(() => ({wch: 18}));
        ws['!cols'] = wscols;
        XLSX.utils.book_append_sheet(wb, ws, "æµæ°´åˆ†æ");
        XLSX.writeFile(wb, `${currentFileName}_åˆ†ææŠ¥è¡¨.xlsx`);
    });

</script>
</body>
</html>
