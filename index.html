<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½æµæ°´è½¬æ¢å™¨ | å¾®ä¿¡æ”¯ä»˜å®é“¶è¡Œ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- å¼•å…¥ SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        .drag-active { border-color: #1677ff; background-color: #e6f7ff; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* å¾®ä¿¡æç¤ºé®ç½© */
        #wx-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; text-align: right; padding-top: 40px; padding-right: 30px; }
        #wx-mask p { color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .badge-wx { background: #07c160; color: white; }
        .badge-ali { background: #1677ff; color: white; }
        .badge-bank { background: #faad14; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-center p-4">

    <!-- å¾®ä¿¡/QQæ‰“å¼€æ—¶çš„æç¤ºé®ç½© -->
    <div id="wx-mask" onclick="this.style.display='none'">
        <p>â†— ç‚¹å‡»å³ä¸Šè§’ ...</p>
        <p>é€‰æ‹©ã€åœ¨æµè§ˆå™¨æ‰“å¼€ã€‘</p>
        <p class="text-sm font-normal opacity-80 mt-2">å¦åˆ™æ— æ³•ä¿å­˜ Excel æ–‡ä»¶</p>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-4xl border border-gray-200 mx-auto">
        <!-- æ ‡é¢˜åŒº -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸ’¸ å…¨èƒ½æµæ°´è½¬æ¢å™¨</h1>
            <div class="flex justify-center gap-2 mt-3">
                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-medium">å¾®ä¿¡æ”¯ä»˜</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-medium">æ”¯ä»˜å®</span>
                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded font-medium">æ‰‹æœºé“¶è¡Œ</span>
            </div>
            <p class="text-xs text-gray-400 mt-3">æ™ºèƒ½è¯†åˆ«æ ¼å¼ Â· è‡ªåŠ¨åˆå¹¶æ‘˜è¦ Â· å‰”é™¤æ— æ•ˆæµæ°´</p>
        </div>

        <!-- ä¸Šä¼ åŒº -->
        <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center active:bg-gray-50 transition-all duration-200 relative overflow-hidden">
            <input type="file" id="file-input" class="hidden" accept=".pdf">
            <div class="relative z-10 flex flex-col items-center justify-center space-y-3">
                <div class="p-4 bg-gray-100 rounded-full text-gray-500 mb-2">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div>
                    <div class="text-lg font-bold text-gray-700">ç‚¹å‡»ä¸Šä¼  PDF è´¦å•</div>
                    <p class="text-xs text-gray-400 mt-2">æ”¯æŒå„å¤§é“¶è¡Œç”µå­å›å•/æµæ°´å•</p>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€ä¸è¿›åº¦ -->
        <div id="status-area" class="mt-6 hidden fade-in">
            <div class="flex items-center justify-between mb-2">
                <span id="status-text" class="text-gray-700 font-medium text-xs">æ­£åœ¨è§£æ...</span>
                <span id="percent-text" class="text-blue-600 font-bold text-xs">0%</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="detected-type" class="text-center mt-3 h-5"></div>
        </div>

        <!-- ç»“æœä¸ä¸‹è½½ -->
        <div id="result-area" class="mt-8 hidden fade-in">
            <!-- æ•°æ®å¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 text-center">
                    <div class="text-gray-500 text-[10px] font-bold uppercase">åŸå§‹å…¥è´¦</div>
                    <div class="text-lg font-bold text-gray-800" id="total-raw-income">Â¥ 0.00</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3 border border-green-200 text-center relative overflow-hidden">
                    <div class="text-green-600 text-[10px] font-bold uppercase">æœ‰æ•ˆæ”¶å…¥</div>
                    <div class="text-xl font-bold text-green-700" id="total-real-income">Â¥ 0.00</div>
                    <!-- è£…é¥°å›¾æ ‡ -->
                    <svg class="absolute -right-2 -bottom-2 w-12 h-12 text-green-200 opacity-50" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                </div>
            </div>

            <button id="download-btn" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center text-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                å¯¼å‡º Excel æŠ¥è¡¨
            </button>
            
            <p class="text-center text-[10px] text-gray-400 mt-4 px-4 leading-relaxed">
                å®‰å“ä¸‹è½½åè¯·è‡³ã€æ–‡ä»¶ç®¡ç† > Downloadã€‘æŸ¥çœ‹<br>iOS è¯·ä¿å­˜è‡³ã€æ–‡ä»¶ã€‘App
            </p>
        </div>
    </div>

    <div class="mt-8 text-center text-gray-300 text-[10px]">
        <p>ğŸ›¡ï¸ å®‰å…¨æ‰¿è¯ºï¼šçº¯å‰ç«¯è§£æï¼Œæ— æœåŠ¡å™¨ä¸Šä¼ </p>
    </div>

<script>
    // DOM Elements
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const statusArea = document.getElementById('status-area');
    const resultArea = document.getElementById('result-area');
    const statusText = document.getElementById('status-text');
    const percentText = document.getElementById('percent-text');
    const progressBar = document.getElementById('progress-bar');
    const downloadBtn = document.getElementById('download-btn');
    const detectedTypeDiv = document.getElementById('detected-type');
    const wxMask = document.getElementById('wx-mask');

    let finalGridData = [];
    let currentFileName = '';
    let allRawItems = [];

    // --- 0. ç¯å¢ƒä¸äº¤äº’ ---
    function isWeChatOrQQ() {
        const ua = navigator.userAgent.toLowerCase();
        return ua.indexOf('micromessenger') !== -1 || ua.indexOf('qq/') !== -1;
    }

    dropZone.addEventListener('click', () => {
        if(isWeChatOrQQ()) { wxMask.style.display = 'block'; return; }
        fileInput.click()
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    // --- 1. æ–‡ä»¶å¤„ç†ä¸»æµç¨‹ ---
    async function handleFile(file) {
        if (file.type !== 'application/pdf') {
            alert('è¯·ä¸Šä¼  PDF æ ¼å¼æ–‡ä»¶');
            return;
        }

        currentFileName = file.name.replace('.pdf', '');
        resetUI();

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const totalPages = pdf.numPages;
            
            // æå–
            for (let i = 1; i <= totalPages; i++) {
                statusText.innerText = `æ‰«æé¡µé¢ ${i}/${totalPages}`;
                updateProgress((i / totalPages) * 60);
                
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                textContent.items.forEach(item => {
                    const text = item.str.trim();
                    if (text) {
                        allRawItems.push({
                            x: Math.round(item.transform[4]),
                            y: Math.round(item.transform[5]),
                            text: text,
                            page: i
                        });
                    }
                });
            }

            // ç»“æ„åŒ–
            statusText.innerText = "è¡¨æ ¼å¯¹é½é‡ç»„...";
            updateProgress(75);
            
            setTimeout(() => {
                let grid = processSmartGrid(allRawItems);
                
                // è¯†åˆ«ä¸åˆ†æ
                statusText.innerText = "è¯†åˆ«æµæ°´ç±»å‹...";
                updateProgress(85);

                setTimeout(() => {
                    finalGridData = analyzeFinancials(grid);
                    updateProgress(100);
                    showResult();
                }, 300);
            }, 50);

        } catch (error) {
            console.error(error);
            if (error.name === 'PasswordException') {
                alert('è¯¥ PDF å·²åŠ å¯†ï¼Œè¯·å…ˆç§»é™¤å¯†ç åå†ä¸Šä¼ ã€‚');
            } else {
                alert('è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶å®Œæ•´ã€‚');
            }
            statusArea.classList.add('hidden');
            dropZone.classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    function resetUI() {
        statusArea.classList.remove('hidden');
        resultArea.classList.add('hidden');
        dropZone.classList.add('opacity-50', 'pointer-events-none');
        updateProgress(0);
        allRawItems = [];
        detectedTypeDiv.innerHTML = '';
    }

    function updateProgress(val) {
        const v = Math.round(val);
        progressBar.style.width = `${v}%`;
        percentText.innerText = `${v}%`;
    }

    function showResult() {
        statusArea.classList.add('hidden');
        resultArea.classList.remove('hidden');
        dropZone.classList.remove('opacity-50', 'pointer-events-none');
    }

    // --- 2. æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½å¯¹é½ ---
    function processSmartGrid(items) {
        if (items.length === 0) return [];
        const Y_TOLERANCE = 4; // è¡Œé«˜å®¹å·®
        const X_TOLERANCE = 15; // åˆ—å®½å®¹å·®

        let allRows = [];
        const maxPage = items[items.length - 1].page;
        for (let p = 1; p <= maxPage; p++) {
            let pageItems = items.filter(i => i.page === p);
            pageItems.sort((a, b) => b.y - a.y); // Yè½´ä»å¤§åˆ°å°ï¼ˆPDFåæ ‡ç³»ï¼‰
            let currentRows = [];
            pageItems.forEach(item => {
                let foundRow = currentRows.find(r => Math.abs(r.y - item.y) < Y_TOLERANCE);
                if (foundRow) foundRow.items.push(item);
                else currentRows.push({ y: item.y, items: [item] });
            });
            allRows.push(...currentRows);
        }

        let allX = items.map(i => i.x);
        let columnCenters = [];
        allX.sort((a, b) => a - b);
        allX.forEach(x => {
            let foundCol = columnCenters.find(c => Math.abs(c - x) < X_TOLERANCE);
            if (!foundCol) columnCenters.push(x);
        });
        columnCenters.sort((a, b) => a - b);

        let grid = [];
        allRows.forEach(row => {
            let rowData = new Array(columnCenters.length).fill("");
            row.items.forEach(item => {
                let bestColIndex = -1;
                let minDiff = Infinity;
                columnCenters.forEach((colX, index) => {
                    let diff = Math.abs(colX - item.x);
                    if (diff < minDiff) { minDiff = diff; bestColIndex = index; }
                });
                if (bestColIndex !== -1) {
                    if (rowData[bestColIndex]) rowData[bestColIndex] += " " + item.text;
                    else rowData[bestColIndex] = item.text;
                }
            });
            if (rowData.some(cell => cell.trim() !== "")) grid.push(rowData);
        });
        return grid;
    }

    // --- 3. æ ¸å¿ƒç®—æ³•ï¼šå…¨èƒ½é‡‘èåˆ†æ ---
    function analyzeFinancials(grid) {
        if (!grid || grid.length < 2) return grid;

        let headerRowIdx = -1;
        let colMap = { date: -1, amount: -1, desc: -1, type: -1 }; // type: æ”¶/æ”¯åˆ—
        let detectedSource = 'é€šç”¨æ ¼å¼';

        // æ™ºèƒ½è¯†åˆ«è¡¨å¤´ä¸æ¥æº
        for (let r = 0; r < Math.min(grid.length, 20); r++) {
            const rowStr = grid[r].join(" ").toLowerCase();
            
            // æ¥æºç‰¹å¾è¯
            if (rowStr.includes("å¾®ä¿¡æ”¯ä»˜")) detectedSource = 'å¾®ä¿¡æ”¯ä»˜';
            else if (rowStr.includes("æ”¯ä»˜å®")) detectedSource = 'æ”¯ä»˜å®';
            else if (rowStr.includes("é“¶è¡Œ") || rowStr.includes("å€Ÿæ–¹é‡‘é¢")) detectedSource = 'é“¶è¡Œæµæ°´';

            // è¡¨å¤´ç‰¹å¾
            if ((rowStr.includes("é‡‘é¢") || rowStr.includes("amount") || rowStr.includes("å€Ÿæ–¹")) && 
                (rowStr.includes("æ—¶é—´") || rowStr.includes("æ—¥æœŸ") || rowStr.includes("date"))) {
                headerRowIdx = r;
                
                grid[r].forEach((cell, cIdx) => {
                    const txt = cell.trim();
                    if (txt.includes("æ—¶é—´") || txt.includes("æ—¥æœŸ") || txt.match(/\d{4}-\d{2}/)) colMap.date = cIdx;
                    else if (txt === "é‡‘é¢(å…ƒ)" || txt === "é‡‘é¢" || txt.includes("äº¤æ˜“é‡‘é¢") || txt.includes("è´·æ–¹å‘ç”Ÿé¢")) colMap.amount = cIdx;
                    else if (txt.includes("æ”¶/æ”¯") || txt.includes("æ”¶æ”¯") || txt.includes("èµ„é‡‘çŠ¶æ€")) colMap.type = cIdx; // å¾®ä¿¡/æ”¯ä»˜å®ç‰¹æœ‰
                    else if (txt.includes("å•†å“") || txt.includes("æ‘˜è¦") || txt.includes("å¯¹æ–¹") || txt.includes("å¤‡æ³¨")) {
                        // ä¼˜å…ˆé€‰æ‹©å†…å®¹ä¸°å¯Œçš„åˆ—
                        if (colMap.desc === -1) colMap.desc = cIdx;
                    }
                });
                break;
            }
        }

        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
        let badgeClass = 'bg-gray-500';
        if(detectedSource.includes('å¾®ä¿¡')) badgeClass = 'badge-wx';
        if(detectedSource.includes('æ”¯ä»˜å®')) badgeClass = 'badge-ali';
        if(detectedSource.includes('é“¶è¡Œ')) badgeClass = 'badge-bank';
        detectedTypeDiv.innerHTML = `<span class="badge ${badgeClass}">${detectedSource}</span>`;

        if (headerRowIdx === -1 || colMap.amount === -1) return grid;

        // æ‰©å±•è¡¨å¤´
        grid[headerRowIdx].push("å®é™…æœ‰æ•ˆæ”¶å…¥");
        grid[headerRowIdx].push("æ™ºèƒ½å¤‡æ³¨");

        let transactions = [];
        let totalRawIncome = 0;
        
        for (let r = headerRowIdx + 1; r < grid.length; r++) {
            const row = grid[r];
            const dateStr = colMap.date > -1 ? row[colMap.date] : "";
            const amountStr = row[colMap.amount];
            // åˆå¹¶æ‰€æœ‰å¯èƒ½çš„æè¿°ä¿¡æ¯ï¼Œé˜²æ­¢æ¼æ‰â€œå¯¹æ–¹åç§°â€
            const descStr = grid[r].map((c, i) => (i !== colMap.date && i !== colMap.amount && i !== colMap.type) ? c : "").join(" ").trim();
            const typeStr = colMap.type > -1 ? row[colMap.type] : ""; // æ”¶/æ”¯ åˆ—çš„å†…å®¹

            // 1. æ—¥æœŸè§£æ
            const dateMatch = dateStr.match(/\d{4}[-./]\d{1,2}[-./]\d{1,2}/);
            const dateKey = dateMatch ? dateMatch[0].replace(/[./]/g, '-') : "unknown";

            // 2. é‡‘é¢ä¸æ”¶æ”¯åˆ¤æ–­
            let amountVal = 0;
            let flowType = "unknown"; // income, expense

            if (amountStr) {
                const cleanAmt = amountStr.replace(/[Â¥,]/g, "").trim();
                amountVal = parseFloat(cleanAmt);
                
                // ä¼˜å…ˆçº§ 1: æ˜ç¡®çš„â€œæ”¶/æ”¯â€åˆ— (å¾®ä¿¡/æ”¯ä»˜å®)
                if (typeStr.includes("æ”¯å‡º") || typeStr.includes("æ”¯ä»˜")) {
                    flowType = "expense";
                } else if (typeStr.includes("æ”¶å…¥") || typeStr.includes("è½¬å…¥") || typeStr.includes("è§£å†»")) {
                    flowType = "income";
                } 
                // ä¼˜å…ˆçº§ 2: é‡‘é¢ç¬¦å· (é“¶è¡Œ/é€šç”¨)
                else if (amountStr.includes("-") || cleanAmt.startsWith("-")) {
                    flowType = "expense";
                } else if (amountStr.includes("+") || !isNaN(amountVal)) {
                    // å¯¹äºæŸäº›é“¶è¡Œå€Ÿè´·åˆ—åˆ†å¼€çš„æƒ…å†µï¼Œéœ€é¢å¤–é€»è¾‘ï¼Œè¿™é‡Œä¸»è¦å¤„ç†å•åˆ—é‡‘é¢
                    flowType = "income"; 
                }

                amountVal = Math.abs(amountVal); // ç»Ÿä¸€è½¬æ­£æ•°å¤„ç†
                
                if (flowType === "income") totalRawIncome += amountVal;
            }

            transactions.push({
                rIdx: r,
                date: dateKey,
                amount: amountVal,
                type: flowType,
                desc: descStr,
                isExcluded: false,
                reason: ""
            });
        }

        // 3. æ™ºèƒ½æ¸…æ´—
        const excludeKeywords = ["æœ¬äºº", "è‡ªå·±", "æç°", "å……å€¼", "ç†è´¢", "èµå›", "å€Ÿå‘—", "å¾®ç²’è´·", "ä¿¡ç”¨å¡", "è¿˜æ¬¾", "é€€æ¬¾", "å®šæœŸ"];
        
        transactions.forEach(tx => {
            if (tx.type === "income") {
                // å…³é”®è¯æ’é™¤
                for (let kw of excludeKeywords) {
                    if (tx.desc.includes(kw)) {
                        tx.isExcluded = true;
                        tx.reason = `æ’é™¤: ${kw}`;
                        break;
                    }
                }
            }
        });

        // 4. å½“æ—¥å¿«è¿›å¿«å‡ºæ’é™¤ (é‡‘é¢ç›¸ä¼¼åº¦åŒ¹é…)
        const txByDate = {};
        transactions.forEach(tx => {
            if (tx.date === "unknown") return;
            if (!txByDate[tx.date]) txByDate[tx.date] = [];
            txByDate[tx.date].push(tx);
        });

        Object.keys(txByDate).forEach(date => {
            const dayTxs = txByDate[date];
            const incomes = dayTxs.filter(t => t.type === "income" && !t.isExcluded);
            const expenses = dayTxs.filter(t => t.type === "expense");

            incomes.forEach(inc => {
                // å¯»æ‰¾é‡‘é¢ç›¸è¿‘çš„æ”¯å‡º (è¯¯å·® < 1%)
                const matchExp = expenses.find(exp => {
                    const diff = Math.abs(exp.amount - inc.amount);
                    return diff < 5 || (diff / inc.amount < 0.01);
                });
                if (matchExp) {
                    inc.isExcluded = true;
                    inc.reason = `æ’é™¤: å¿«è¿›å¿«å‡º (Â¥${matchExp.amount})`;
                }
            });
        });

        // 5. æ±‡æ€»ä¸å›å¡«
        let totalRealIncome = 0;
        transactions.forEach(tx => {
            const row = grid[tx.rIdx];
            if (tx.type === "income") {
                if (tx.isExcluded) {
                    row.push("0");
                    row.push(tx.reason);
                } else {
                    row.push(tx.amount.toFixed(2));
                    row.push("æœ‰æ•ˆæ”¶å…¥");
                    totalRealIncome += tx.amount;
                }
            } else {
                row.push(""); // æ”¯å‡ºè¡Œç•™ç©º
                row.push("");
            }
        });

        // è¡¥é½ Footer
        for (let r = headerRowIdx + 1; r < grid.length; r++) {
            while (grid[r].length < grid[headerRowIdx].length) grid[r].push("");
        }

        document.getElementById('total-raw-income').innerText = `Â¥ ${totalRawIncome.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
        document.getElementById('total-real-income').innerText = `Â¥ ${totalRealIncome.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;

        return grid;
    }

    // --- 4. å¯¼å‡º ---
    downloadBtn.addEventListener('click', () => {
        if (!finalGridData.length) return;
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(finalGridData);
        // ä¼˜åŒ–åˆ—å®½
        const wscols = finalGridData[0].map((_, i) => ({wch: i === finalGridData[0].length - 1 ? 30 : 18}));
        ws['!cols'] = wscols;
        
        XLSX.utils.book_append_sheet(wb, ws, "æµæ°´åˆ†æ");
        XLSX.writeFile(wb, `${currentFileName}_æ™ºèƒ½åˆ†æ.xlsx`);
        
        // å»¶è¿Ÿæç¤º
        setTimeout(() => {
            alert('ğŸ“¥ ä¸‹è½½å·²å¼€å§‹\nå®‰å“ç”¨æˆ·è¯·æŸ¥çœ‹é€šçŸ¥æ æˆ– Download æ–‡ä»¶å¤¹');
        }, 800);
    });

</script>
</body>
</html>
